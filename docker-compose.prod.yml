# =============================================================================
# PRODUCTION DOCKER COMPOSE
# =============================================================================
# This compose file pulls pre-built images from GitHub Container Registry.
# Images are built and pushed by GitHub Actions - this server just runs them.
#
# Usage:
#   docker compose -f docker-compose.prod.yml pull
#   docker compose -f docker-compose.prod.yml up -d
#
# Rollback to specific version:
#   IMAGE_TAG=abc1234 docker compose -f docker-compose.prod.yml up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Database
  # ---------------------------------------------------------------------------
  # PostgreSQL stays as-is - we don't build custom images for the database.
  # Using the official postgres:16 image directly.
  oasis:
    container_name: oasis-db
    image: postgres:16
    restart: always
    env_file:
      - .env
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./scripts/db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20

  # ---------------------------------------------------------------------------
  # Database Migrations
  # ---------------------------------------------------------------------------
  # Runs all SQL files in scripts/db/init on every deploy.
  # Uses IF NOT EXISTS patterns so it's safe to run repeatedly.
  oasis-migrations:
    container_name: oasis-migrations
    image: postgres:16
    volumes:
      - ./scripts/db/init:/migrations:ro
    env_file:
      - .env
    depends_on:
      oasis:
        condition: service_healthy
    entrypoint: >
      sh -c '
        for f in /migrations/*.sql; do
          echo "Running migration: $$f"
          psql -h oasis -U $$POSTGRES_USER -d $$POSTGRES_DB -f "$$f"
        done
        echo "Migrations complete!"
      '
    restart: "no"

  # ---------------------------------------------------------------------------
  # Web Frontend
  # ---------------------------------------------------------------------------
  # Pulls from ghcr.io/jcquinlan/oasis-web
  # IMAGE_TAG defaults to 'latest' but can be overridden for rollbacks
  oasis-web:
    container_name: oasis-web
    image: ghcr.io/jcquinlan/oasis-web:${IMAGE_TAG:-latest}
    ports:
      - "127.0.0.1:8081:3000"
    restart: always
    environment:
      - NODE_ENV=production
    depends_on:
      - oasis-api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # API Server
  # ---------------------------------------------------------------------------
  # Pulls from ghcr.io/jcquinlan/oasis-api
  # Mounts docker socket and /proc for system monitoring capabilities
  oasis-api:
    container_name: oasis-api
    image: ghcr.io/jcquinlan/oasis-api:${IMAGE_TAG:-latest}
    ports:
      - "127.0.0.1:8082:3001"
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host/proc:ro
    environment:
      - NODE_ENV=production
      - PROC_PATH=/host/proc
      - DATABASE_URL=${DATABASE_URL}
    depends_on:
      oasis:
        condition: service_healthy
      oasis-migrations:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3001/api/health').then(r => process.exit(r.ok ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # Book Recommendation Service
  # ---------------------------------------------------------------------------
  # Pulls from ghcr.io/jcquinlan/book-service
  # Provides personalized book recommendations with availability checking
  book-service:
    container_name: book-service
    image: ghcr.io/jcquinlan/book-service:${IMAGE_TAG:-latest}
    ports:
      - "127.0.0.1:8083:3002"
    restart: always
    volumes:
      - ./data/book-service:/app/data
    environment:
      - NODE_ENV=production
      - PORT=3002
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - BOOK_PRICE_CEILING=${BOOK_PRICE_CEILING:-20}
      - BOOK_FORMATS=${BOOK_FORMATS:-ebook,paperback}
      - BOOK_CANDIDATE_COUNT=${BOOK_CANDIDATE_COUNT:-20}
      - BOOK_MAX_RESULTS=${BOOK_MAX_RESULTS:-10}
      - BOOK_CACHE_TTL_HOURS=${BOOK_CACHE_TTL_HOURS:-48}
      - BOOK_ENABLED_SOURCES=${BOOK_ENABLED_SOURCES:-open_library,thriftbooks}
      - BOOK_LLM_PROVIDER=${BOOK_LLM_PROVIDER:-openai}
      - BOOK_LLM_MODEL=${BOOK_LLM_MODEL:-gpt-4o-mini}
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3002/api/health').then(r => process.exit(r.ok ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

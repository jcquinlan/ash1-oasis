# =============================================================================
# PRODUCTION DOCKER COMPOSE
# =============================================================================
# This compose file pulls pre-built images from GitHub Container Registry.
# Images are built and pushed by GitHub Actions - this server just runs them.
#
# Usage:
#   docker compose -f docker-compose.prod.yml pull
#   docker compose -f docker-compose.prod.yml up -d
#
# Rollback to specific version:
#   IMAGE_TAG=abc1234 docker compose -f docker-compose.prod.yml up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Database
  # ---------------------------------------------------------------------------
  # PostgreSQL stays as-is - we don't build custom images for the database.
  # Using the official postgres:16 image directly.
  oasis:
    container_name: oasis-db
    image: postgres:16
    restart: always
    env_file:
      - .env
    volumes:
      - oasis-pgdata:/var/lib/postgresql/data
      - ./scripts/db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20

  # ---------------------------------------------------------------------------
  # Database Migrations
  # ---------------------------------------------------------------------------
  # Runs all SQL files in scripts/db/init on every deploy.
  # Uses IF NOT EXISTS patterns so it's safe to run repeatedly.
  oasis-migrations:
    container_name: oasis-migrations
    image: postgres:16
    volumes:
      - ./scripts/db/init:/migrations:ro
    env_file:
      - .env
    depends_on:
      oasis:
        condition: service_healthy
    entrypoint: >
      sh -c '
        export PGPASSWORD=$$POSTGRES_PASSWORD
        for f in /migrations/*.sql; do
          echo "Running migration: $$f"
          psql -h oasis -U $$POSTGRES_USER -d $$POSTGRES_DB -f "$$f"
        done
        echo "Migrations complete!"
      '
    restart: "no"

  # ---------------------------------------------------------------------------
  # Web Frontend
  # ---------------------------------------------------------------------------
  # Pulls from ghcr.io/jcquinlan/oasis-web
  # IMAGE_TAG defaults to 'latest' but can be overridden for rollbacks
  oasis-web:
    container_name: oasis-web
    image: ghcr.io/jcquinlan/oasis-web:${IMAGE_TAG:-latest}
    ports:
      - "127.0.0.1:8081:3000"
    restart: always
    environment:
      - NODE_ENV=production
    depends_on:
      - oasis-api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # API Server
  # ---------------------------------------------------------------------------
  # Pulls from ghcr.io/jcquinlan/oasis-api
  # Mounts docker socket and /proc for system monitoring capabilities
  oasis-api:
    container_name: oasis-api
    image: ghcr.io/jcquinlan/oasis-api:${IMAGE_TAG:-latest}
    ports:
      - "127.0.0.1:8082:3001"
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host/proc:ro
    environment:
      - NODE_ENV=production
      - PROC_PATH=/host/proc
      - DATABASE_URL=${DATABASE_URL}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-}
      - CORS_ORIGINS=${CORS_ORIGINS:-}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
    depends_on:
      oasis:
        condition: service_healthy
      oasis-migrations:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3001/api/health').then(r => process.exit(r.ok ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # MCP Server
  # ---------------------------------------------------------------------------
  # Exposes homelab data to Claude Desktop / Claude Code via MCP tools.
  # Calls oasis-api internally — no direct DB or Docker socket access.
  oasis-mcp:
    container_name: oasis-mcp
    image: ghcr.io/jcquinlan/oasis-mcp:${IMAGE_TAG:-latest}
    ports:
      - "127.0.0.1:8083:3002"
    restart: always
    environment:
      - NODE_ENV=production
      - MCP_PORT=3002
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - OASIS_API_URL=http://oasis-api:3001
    depends_on:
      - oasis-api
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3002/health').then(r => process.exit(r.ok ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # Database Backup Scheduler
  # ---------------------------------------------------------------------------
  # Runs pg_dump daily at 3:00 AM, keeps 7 days of backups.
  # This is a long-running scheduler — starts with `up -d` alongside other services.
  #
  # For one-shot pre-deploy backups, use `docker compose exec` on the database
  # directly — do NOT `docker compose run oasis-backup` (the scheduler loop
  # never exits and will hang your deploy).
  oasis-backup:
    container_name: oasis-backup
    image: postgres:16
    volumes:
      - oasis-backups:/backups
      - ./scripts/backup-postgres.sh:/scripts/backup-postgres.sh:ro
    env_file:
      - .env
    depends_on:
      oasis:
        condition: service_healthy
    entrypoint: >
      sh -c '
        echo "Backup scheduler starting — daily at 3:00 AM"
        while true; do
          NEXT_3AM=$$(date -d "tomorrow 03:00" +%s 2>/dev/null || date -d "tomorrow" +%s)
          NOW=$$(date +%s)
          SLEEP_SEC=$$((NEXT_3AM - NOW))
          if [ "$$SLEEP_SEC" -le 0 ]; then SLEEP_SEC=86400; fi
          echo "Next backup in $$SLEEP_SEC seconds"
          sleep "$$SLEEP_SEC"
          echo "--- Backup triggered at $$(date) ---"
          /scripts/backup-postgres.sh
        done
      '
    restart: always

# =============================================================================
# Named Volumes
# =============================================================================
# Named volumes are managed by Docker and are NOT removed by:
#   docker compose down        (safe)
#   docker compose down -v     (DESTROYS volumes — never use in production)
#   rm -rf ./data              (no effect — data is in Docker's volume store)
#
# To inspect: docker volume inspect ash1-oasis_oasis-pgdata
# To list:    docker volume ls | grep oasis
volumes:
  oasis-pgdata:
    name: oasis-pgdata
  oasis-backups:
    name: oasis-backups


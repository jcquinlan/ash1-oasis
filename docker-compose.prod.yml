# =============================================================================
# PRODUCTION DOCKER COMPOSE
# =============================================================================
# This compose file pulls pre-built images from GitHub Container Registry.
# Images are built and pushed by GitHub Actions - this server just runs them.
#
# Usage:
#   docker compose -f docker-compose.prod.yml pull
#   docker compose -f docker-compose.prod.yml up -d
#
# Rollback to specific version:
#   IMAGE_TAG=abc1234 docker compose -f docker-compose.prod.yml up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Database
  # ---------------------------------------------------------------------------
  # PostgreSQL stays as-is - we don't build custom images for the database.
  # Using the official postgres:16 image directly.
  oasis:
    container_name: oasis-db
    image: postgres:16
    restart: always
    env_file:
      - .env
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./scripts/db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20

  # ---------------------------------------------------------------------------
  # Database Migrations
  # ---------------------------------------------------------------------------
  # Runs all SQL files in scripts/db/init on every deploy.
  # Uses IF NOT EXISTS patterns so it's safe to run repeatedly.
  oasis-migrations:
    container_name: oasis-migrations
    image: postgres:16
    volumes:
      - ./scripts/db/init:/migrations:ro
    env_file:
      - .env
    depends_on:
      oasis:
        condition: service_healthy
    entrypoint: >
      sh -c '
        for f in /migrations/*.sql; do
          echo "Running migration: $$f"
          psql -h oasis -U $$POSTGRES_USER -d $$POSTGRES_DB -f "$$f"
        done
        echo "Migrations complete!"
      '
    restart: "no"

  # ---------------------------------------------------------------------------
  # Docker Socket Proxy
  # ---------------------------------------------------------------------------
  # Restricts Docker API access to read-only container listing.
  # The API container connects here instead of mounting the raw Docker socket.
  docker-socket-proxy:
    container_name: oasis-docker-proxy
    image: tecnativa/docker-socket-proxy:0.2
    restart: always
    environment:
      - CONTAINERS=1     # Allow GET /containers
      - POST=0           # Block all POST requests
      - IMAGES=0
      - NETWORKS=0
      - VOLUMES=0
      - SERVICES=0
      - TASKS=0
      - NODES=0
      - SWARM=0
      - BUILD=0
      - EXEC=0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # ---------------------------------------------------------------------------
  # Web Frontend
  # ---------------------------------------------------------------------------
  # Pulls from ghcr.io/jcquinlan/oasis-web
  # IMAGE_TAG defaults to 'latest' but can be overridden for rollbacks
  oasis-web:
    container_name: oasis-web
    image: ghcr.io/jcquinlan/oasis-web:${IMAGE_TAG:-latest}
    ports:
      - "127.0.0.1:8081:3000"
    restart: always
    environment:
      - NODE_ENV=production
    depends_on:
      - oasis-api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # API Server
  # ---------------------------------------------------------------------------
  # Pulls from ghcr.io/jcquinlan/oasis-api
  # Connects to Docker socket proxy for container monitoring.
  # Mounts only the specific /proc files needed for system metrics.
  oasis-api:
    container_name: oasis-api
    image: ghcr.io/jcquinlan/oasis-api:${IMAGE_TAG:-latest}
    ports:
      - "127.0.0.1:8082:3001"
    restart: always
    volumes:
      - /proc/uptime:/host/proc/uptime:ro
      - /proc/meminfo:/host/proc/meminfo:ro
      - /proc/loadavg:/host/proc/loadavg:ro
    environment:
      - NODE_ENV=production
      - PROC_PATH=/host/proc
      - DATABASE_URL=${DATABASE_URL}
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
      - API_KEY=${API_KEY}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
    depends_on:
      oasis:
        condition: service_healthy
      oasis-migrations:
        condition: service_completed_successfully
      docker-socket-proxy:
        condition: service_started
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3001/api/health').then(r => process.exit(r.ok ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
